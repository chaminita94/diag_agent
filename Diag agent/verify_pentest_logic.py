import requests
from unittest.mock import MagicMock
from enum import Enum
from typing import Tuple

# Minimal classes for testing
class Severity(Enum):
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    INFO = "INFO"

class FindingStatus(Enum):
    CONFIRMED_EXPOSURE = "CONFIRMED_EXPOSURE"
    ACCESS_CONTROLLED = "ACCESS_CONTROLLED"
    REDIRECTED = "REDIRECTED"
    SPA_ROUTED = "SPA_ROUTED"
    INFORMATIONAL = "INFORMATIONAL"
    POTENTIAL = "POTENTIAL"

def _is_spa_routing(body: str) -> bool:
    if not body: return False
    spa_markers = ['<div id="root">', '<div id="app">', '<app-root>', 'window.__NEXT_DATA__']
    body_lower = body.lower()
    score = sum(1 for m in spa_markers if m.lower() in body_lower)
    return score >= 1 and len(body) < 5000

def _classify_exposure(resp, path, base_url="https://example.com") -> Tuple[FindingStatus, str]:
    status_code = resp.status_code
    body = resp.text or ""
    content_type = resp.headers.get("Content-Type", "").lower()
    
    informational_paths = ["robots.txt", "security.txt", "humans.txt"]
    if any(path.endswith(p) for p in informational_paths):
        return FindingStatus.INFORMATIONAL, Severity.INFO.value

    if resp.history:
        final_url = resp.url.lower()
        if "login" in final_url or final_url.rstrip("/") == base_url.lower().rstrip("/"):
            return FindingStatus.REDIRECTED, Severity.INFO.value
        return FindingStatus.REDIRECTED, Severity.LOW.value

    if status_code in [403, 401]:
        return FindingStatus.ACCESS_CONTROLLED, Severity.INFO.value
    
    if status_code != 200:
        return FindingStatus.INFORMATIONAL, Severity.INFO.value

    if _is_spa_routing(body):
        return FindingStatus.SPA_ROUTED, Severity.INFO.value

    if "404" in body[:500] or "not found" in body[:500].lower():
        if len(body) < 2000:
            return FindingStatus.SPA_ROUTED, Severity.INFO.value

    sensitive_indicators = ["password", "secret", "api_key", "<?php"]
    has_sensitive_content = any(ind.lower() in body.lower() for ind in sensitive_indicators)
    
    if len(body) > 10:
        if has_sensitive_content:
            return FindingStatus.CONFIRMED_EXPOSURE, Severity.CRITICAL.value
        return FindingStatus.CONFIRMED_EXPOSURE, Severity.MEDIUM.value

    return FindingStatus.INFORMATIONAL, Severity.INFO.value

# Test Cases
def test():
    print("Running Classification Tests...")
    
    # CASE 1: Real .env exposure
    r1 = MagicMock(spec=requests.Response)
    r1.status_code = 200
    r1.text = "DB_PASSWORD=secret123\nAPI_KEY=xyz"
    r1.headers = {"Content-Type": "text/plain"}
    r1.history = []
    r1.url = "https://example.com/.env"
    s, sev = _classify_exposure(r1, ".env")
    print(f"Test .env Real: {s} | {sev} (Expected: CONFIRMED_EXPOSURE | CRITICAL)")

    # CASE 2: Redirect to login (False Positive)
    r2 = MagicMock(spec=requests.Response)
    r2.status_code = 200
    r2.text = "<html><body>Login Page</body></html>"
    r2.headers = {"Content-Type": "text/html"}
    hist = MagicMock(spec=requests.Response)
    hist.url = "https://example.com/.env"
    r2.history = [hist]
    r2.url = "https://example.com/login"
    s, sev = _classify_exposure(r2, ".env")
    print(f"Test .env Redirect: {s} | {sev} (Expected: REDIRECTED | INFO)")

    # CASE 3: SPA Routing (False Positive)
    r3 = MagicMock(spec=requests.Response)
    r3.status_code = 200
    r3.text = '<html><div id="root"></div><script src="/static/js/main.js"></script></html>'
    r3.headers = {"Content-Type": "text/html"}
    r3.history = []
    r3.url = "https://example.com/.env"
    s, sev = _classify_exposure(r3, ".env")
    print(f"Test .env SPA: {s} | {sev} (Expected: SPA_ROUTED | INFO)")

    # CASE 4: robots.txt (Informational)
    r4 = MagicMock(spec=requests.Response)
    r4.status_code = 200
    r4.text = "User-agent: *"
    r4.headers = {"Content-Type": "text/plain"}
    r4.history = []
    r4.url = "https://example.com/robots.txt"
    s, sev = _classify_exposure(r4, "robots.txt")
    print(f"Test robots.txt: {s} | {sev} (Expected: INFORMATIONAL | INFO)")

if __name__ == "__main__":
    test()
