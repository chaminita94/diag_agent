# Pentest Agent (Auditoria Web)

El **Pentest Agent** és un mòdul especialitzat integrat al Diag Agent que permet realitzar auditories de seguretat en aplicacions web. Està dissenyat per detectar vulnerabilitats comunes del **OWASP Top 10**.

---

## Capacitats del Mòdul

L'agent (`pentest_agent.py`) és un motor autònom que executa els següents motors d'escaneig:

| Motor | Descripció |
|-------|------------|
| **SQL Injection** | Detecció de vulnerabilitats basades en temps, errors i unions (Union-based). |
| **XSS (Cross-Site Scripting)** | Identificació de reflexió de payloads en paràmetres GET/POST i formularis. |
| **LFI / Path Traversal** | Comprovació d'accés a fitxers sensibles com `/etc/passwd`. |
| **CORS Misconfiguration** | Anàlisi de polítiques d'origen creuat excessivament permissives. |
| **Security Headers** | Verificació de la presència i configuració de CSP, HSTS, X-Frame-Options, etc. |
| **Cookie Security** | Revisió dels atributs `HttpOnly`, `Secure` i `SameSite`. |
| **Sensitive File Discovery** | Detecció de fitxers exposats (.env, config.php, backup.sql, etc.) |

---

## Flux de l'Escaneig

L'escaneig segueix un procés estructurat per maximitzar la cobertura sense ser excessivament invasiu:

1. **Reconnaissance**: Identificació de la tecnologia del servidor i headers inicials.
2. **Crawling**: Descobriment recursiu de rutes, formularis i paràmetres (limitat per profunditat).
3. **Fuzzing i Payload Injection**: Proves actives amb payloads optimitzats per a cada tipus de vulnerabilitat.
4. **Anàlisi de Respostes**: Verificació de signatures d'error, temps de resposta o reflexió de contingut.

---

## ExplanationDatabase - Context Professional

Una de les millores més importants del mòdul és la **classe `ExplanationDatabase`**, que proporciona explicacions llegibles per humans per a cada tipus de vulnerabilitat detectada.

### Per què és important?

- **Abans**: Els informes automàtics només mostraven "SQL Injection detectat" sense context addicional
- **Ara**: Cada descoberta inclou una explicació d'1-2 paràgrafs sobre què significa i per què és important
- **Benefici**: Els informes són comprensibles per a auditors, directius i professors sense coneixements tècnics profunds

### Exemple de Funcionament

```python
class ExplanationDatabase:
    EXPLANATIONS = {
        "Missing Security Headers": {
            "text": "The application response does not include one or more recommended HTTP security headers (such as Content-Security-Policy, X-Frame-Options, or X-Content-Type-Options). While this does not constitute an exploitable vulnerability on its own, missing headers can reduce browser-level protections against clickjacking, XSS, and MIME-type attacks.",
            "impact": "Reduced defense-in-depth against client-side attacks."
        }
    }
```

Aquesta base de dades conté explicacions per:
- SQL Injection
- Cross-Site Scripting
- Missing Security Headers
- Technology Fingerprinting
- Sensitive File Exposure
- Access Controlled Resources
- I més...

---

## Sistema de Classificació Intel·ligent

Un dels problemes dels escàners automàtics és la generació de **falsos positius**. Per exemple, un escàner tradicional podria reportar 133 "vulnerabilitats" quan en realitat només n'hi ha 4-5 de reals.

### Problema Anterior
- **404 Not Found**: Es comptaven com a "descobertes informatives"
- **200 OK genèric**: Pàgines SPA o errors 404 personalitzats es marcaven com a exposicions
- **Resultat**: Informes inflats amb baixa credibilitat

### Solució Actual: FindingStatus

S'ha implementat un sistema estricte de classificació mitjançant l'enum `FindingStatus`:

```python
class FindingStatus(Enum):
    CONFIRMED = "CONFIRMED"           # Prova verificada d'explotabilitat
    ENUMERATED = "ENUMERATED"         # Comportament observat sense prova directa
    ACCESS_CONTROLLED = "ACCESS_CONTROLLED"  # 403/401 - Recurs protegit
    REDIRECTED = "REDIRECTED"         # 301/302 - Redirecció
    INFORMATIONAL = "INFORMATIONAL"   # Informació pública (robots.txt)
    NOT_FOUND = "NOT_FOUND"          # 404 - No existeix
    NOT_EXPOSED = "NOT_EXPOSED"      # 200 OK però sense contingut sensible
```

### Lògica de Classificació (`_classify_exposure`)

El mètode `_classify_exposure()` és el "cervell" del scanner. Decideix com tractar cada resposta HTTP:

| Codi HTTP | Context | Classificació | Severitat |
|-----------|---------|---------------|-----------|
| 404 | Qualsevol | `NOT_FOUND` → Appendix | N/A |
| 200 | HTML genèric | `NOT_EXPOSED` | N/A |
| 200 | Conté "password", "secret" | `CONFIRMED` | CRITICAL |
| 200 | Fitxer binari (.sql, .zip) | `CONFIRMED` | HIGH |
| 200 | Contingut vàlid sense proves | `ENUMERATED` | MEDIUM |
| 403 / 401 | Qualsevol | `ACCESS_CONTROLLED` | LOW/INFO |
| 301 / 302 | Redirecció a login | `REDIRECTED` | INFO |

### Resultat Real

**Abans de la millora**:
```
Total Findings: 133
├─ CRITICAL: 45 (falsos positius)
├─ HIGH: 62 (falsos positius)
└─ INFO: 26 (404s barrejats)
```

**Després de la millora**:
```
Total Findings: 4
├─ MEDIUM: 2 (Missing Security Headers, Technology Fingerprinting)
├─ LOW: 1 (Access Controlled Resource)
└─ INFO: 1 (Public Information)

Appendix - Enumerated Paths (Not Found): 89 paths
```

---

## Format PDF Millorat

Els informes PDF han estat completament redissenyats per millorar la llegibilitat i professionalitat.

### Disseny de Taula de 2 Files

**Problema anterior**: Les URLs llargues es truncaven, les explicacions ocupaven massa espai i dificultaven la lectura.

**Solució implementada**: Cada descoberta ara utilitza **2 files** a la taula:

**Fila 1 (Metadades)**:
| Severity | Status | Type | Evidence | Confidence |
|----------|--------|------|----------|------------|
| MEDIUM | ENUMERATED | Missing Security Headers | 200 \| text/html | CONFIRMED |

**Fila 2 (Detalls)**:
```
URL: http://testasixvb.insebre.com/admin/config.php
Details: The application response does not include one or more recommended HTTP security headers...
```

**Avantatges**:
- La URL obté el 100% de l'amplada de la taula
- La informació es pot llegir sense truncar
- L'explicació és llegible sense comprimir les altres columnes

### Llegenda d'Estats

Cada informe PDF ara inclou una **llegenda d'estats** estandarditzada:

> **Definició d'Estats**
> - **CONFIRMED**: Descoberta d'alta confiança amb proves d'explotabilitat
> - **ENUMERATED**: Comportament observat sense proves directes d'explotabilitat
> - **ACCESS CONTROLLED**: El recurs existeix però està correctament protegit (403 Forbidden)
> - **INFORMATIONAL**: Informació pública o esperada sense impacte de seguretat directe

### Avaluació General de Seguretat

Al començament de cada informe PDF, es genera una **avaluació automàtica** basada en els descobriments:

- **Sense vulnerabilitats crítiques**: "The security posture appears robust based on the scope of this automated scan."
- **Amb vulnerabilitats altes**: "The security posture shows signs of significant risk..."
- **Amb vulnerabilitats crítiques**: "The security posture requires **IMMEDIATE ATTENTION**..."

### Appendix: Rutes Enumerades

Tots els camins que retornen 404 es llisten en un **Appendix separat** al final de l'informe:

```
Appendix: Enumerated Paths (Not Found)

The following paths were probed but returned 404 Not Found.
They are listed here for completeness but are NOT considered vulnerabilities.

• /admin/config.php
• /backup.sql
• /.env
• /phpinfo.php
...
```

Això manté la **transparència** (l'auditor pot veure què es va provar) sense **inflar el comptador** de vulnerabilitats.

---

## Generació Unificada de PDFs

Anteriorment, el codi tenia **dues funcions diferents** per generar PDFs:
- Una per a descàrrega directa (`pentest_pdf`)
- Una altra per a Telegram (`api_pentest_telegram`)

Això causava **inconsistències**: els informes podien tenir formats diferents.

**Solució**: S'ha creat la funció `generate_pentest_report_pdf()` que és utilitzada per ambdós casos, garantint que:
- El PDF descarregat des de la web
- El PDF enviat per Telegram

...siguin **100% idèntics** en format, contingut i estil.

---

## Configuració Avançada

Des de la interfície del Diag Agent, es poden ajustar els paràmetres de l'escaneig:

- **Threads**: Nombre de fils simultanis (recomanat: 5-10).
- **Max Requests**: Límit total de peticions per evitar bloquejos (per defecte: 500).
- **Profunditat (Depth)**: Nivell de navegació recursiva des de la URL llavor.
- **Delay**: Temps d'espera entre peticions per evitar detecció WAF/IDS.

---

## Resultats i Evidències

Cada descoberta (Finding) inclou informació detallada per a la seva mitigació:

- **Severitat**: Critical, High, Medium, Low o Info.
- **Confiança**: Confirmed, High, Medium o Low.
- **Status**: CONFIRMED, ENUMERATED, ACCESS_CONTROLLED, etc.
- **Payload**: El codi o cadena exacta utilitzada per disparar la vulnerabilitat.
- **Context**: URL afectada i paràmetre vulnerable.
- **Evidència Tècnica**:
  - HTTP Status Code (200, 403, 302, etc.)
  - Content-Type (application/json, text/html, etc.)
  - Body Fingerprint (json_data, potential_secrets, etc.)
- **Explicació Professional**: Text d'1-2 paràgrafs explicant l'impacte

---

## Estadístiques del Codi

El mòdul Pentest Agent consta de:

- **Fitxer principal**: `pentest_agent.py`
- **Línies de codi**: ~3.141
- **Classes principals**: `PentestAgent`, `GoogleDorker`, `ExplanationDatabase`
- **Mètodes d'escaneig**: 15+
- **Payloads SQL Injection**: 20+ variants
- **Payloads XSS**: 15+ vectors
- **Fitxers sensibles**: 50+ patterns

---

!!! warning "Ús Ètic"
    Recorda que realitzar proves de penetració sense autorització és il·legal. Utilitza aquest mòdul només en entorns controlats o sobre actius dels quals siguis propietari.

---

!!! info "Impacte de les Millores"
    Les millores implementades durant aquest projecte han transformat el Pentest Agent d'una eina que generava informes inflats i poc professionals a un scanner que produeix informes d'**auditoria professional** comparables als informes manuals de consultories de ciberseguretat.

